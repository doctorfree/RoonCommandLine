#!/bin/bash

ROON=/usr/local/Roon
ROONETC=${ROON}/etc
ROONFADE=${ROONETC}/roon_faded
ROONCONF=${ROONETC}/pyroonconf
LOG=

# Get the zone if it is set
if [ -f ${ROONCONF} ]
then
    . ${ROONCONF}
else
    DEFZONE=`grep ^DefaultZone ${ROONETC}/roon_api.ini | awk -F '=' ' { print $2 } '`
    ${ROON}/bin/set_zone $DEFZONE
    . ${ROONCONF}
fi

# Parse the arguments to get the command and zone
while getopts "lz:" flag; do
    case $flag in
        l)
            LOG="-l"
            ;;
        z)
            ROON_ZONE="$OPTARG"
            ;;
    esac
done
shift $(( OPTIND - 1 ))

if [ "$1" ]
then
    argument=`echo "$1" | tr '[:upper:]' '[:lower:]'`
    if [ "${argument}" == "on" ]
    then
        if [ -x ${ROONFADE} ]
        then
            [ "${ROON_FADE}" ] || {
                grep -v ROON_FADE ${ROONCONF} > /tmp/pyroon$$
                echo "ROON_FADE=true" >> /tmp/pyroon$$
                cp /tmp/pyroon$$ ${ROONCONF}
                rm -f /tmp/pyroon$$
            }
            [ "${FADE_TIME}" ] || {
                grep -v FADE_TIME ${ROONCONF} > /tmp/pyroon$$
                echo "FADE_TIME=30" >> /tmp/pyroon$$
                cp /tmp/pyroon$$ ${ROONCONF}
                rm -f /tmp/pyroon$$
            }
            echo "Starting Roon fade daemon ${ROONFADE}"
            ${ROONFADE} ${LOG} -z "${ROON_ZONE}" > /dev/null 2>&1 &
        else
            echo "Roon fade daemon ${ROONFADE} not found or not executable"
        fi
    else
        if [ "${argument}" == "off" ]
        then
            [ "${ROON_FADE}" ] && {
                grep -v ROON_FADE ${ROONCONF} > /tmp/pyroon$$
                echo "ROON_FADE=" >> /tmp/pyroon$$
                cp /tmp/pyroon$$ ${ROONCONF}
                rm -f /tmp/pyroon$$
                echo "Roon fade disabled in ${ROONCONF}"
            }
        else
            echo "Usage: roon_fade [-l] [on|off]"
            exit 1
        fi
    fi
else
    if [ "${ROON_FADE}" ]
    then
        echo "Roon fade is enabled"
        echo "Execute 'roon_fade off' to disable"
    else
        echo "Roon fade is disabled"
        echo "Execute 'roon_fade on' to enable"
    fi
fi
exit 0
