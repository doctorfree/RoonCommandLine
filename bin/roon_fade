#!/bin/bash

ROON=/usr/local/Roon
ROONETC=${ROON}/etc
ROONFADE=${ROONETC}/roon_faded
ROONCONF=${ROONETC}/pyroonconf
POS_INT='^[1-9][0-9]*(,[1-9][0-9]*)*$'
FADE_ZONE=
LOG=

# Get the zone and fade settings
init_pyroon() {
  if [ -f ${ROONCONF} ]
  then
    . ${ROONCONF}
  else
    DEFZONE=`grep ^DefaultZone ${ROONETC}/roon_api.ini | \
        awk -F '=' ' { print $2 } '`
    ${ROON}/bin/set_zone $DEFZONE
    . ${ROONCONF}
  fi
}

usage() {
  printf "\nUsage: roon_fade [-iI] [-l] [-R] [-V] [-t seconds] [-uh] [-y] [-z zone] on|off|now"
  printf "\nWhere:"
  printf "\n\t-i enables fade in next track after fading out"
  printf "\n\t-I disables fade in, immediately restore volume after fading"
  printf "\n\t-l enables logging"
  printf "\n\t-R restores faded or modified volume to original levels"
  printf "\n\t-V updates fading restore volume to current volume levels"
  printf "\n\t\t(use 'roon_fade -V' after manually adjusting volume)"
  printf "\n\t-t 'seconds' sets the fade duration in seconds (default: 30)"
  printf "\n\t-y indicates do not prompt, assume the answer is 'yes' and proceed"
  printf "\n\t-z 'zone' sets the Roon zone in which to fade"
  printf "\n\t\tIf no zone is specified, the default zone is used\n"
  printf "\nAn argument of 'on' enables fading, 'off' disables fading"
  printf "\nAn argument of 'now' fades volume immediately"
  printf "\nWithout arguments or with '-u' or '-h' this usage message is displayed\n"
  if [ "${ROON_FADE}" = true ]
  then
    if [ "${FADE_ZONE}" ]
    then
      printf "\nRoon volume fading is currently enabled in zone ${FADE_ZONE}"
    else
      printf "\nRoon volume fading is currently enabled"
    fi
    printf "\nFade duration set to ${FADE_TIME} seconds"
    if [ "${FADE_IN}" = true ]
    then
      printf "\nFade back in is enabled"
    else
      printf "\nFade back in is disabled"
    fi
    printf "\nExecute 'roon_fade off' to disable\n\n"
  else
    printf "\nRoon volume fading is currently disabled"
    printf "\nExecute 'roon_fade on' to enable fading last ${FADE_TIME} seconds\n\n"
  fi
  exit 1
}

set_fade_zone() {
    grep -v FADE_ZONE ${ROONCONF} > /tmp/pyroon$$
    echo "FADE_ZONE=\"${FADE_ZONE}\"" >> /tmp/pyroon$$
    cp /tmp/pyroon$$ ${ROONCONF}
    rm -f /tmp/pyroon$$
}

set_roon_fade() {
    grep -v ROON_FADE ${ROONCONF} > /tmp/pyroon$$
    if [ "$1" == "on" ]
    then
      echo "ROON_FADE=true" >> /tmp/pyroon$$
    else
      echo "ROON_FADE=false" >> /tmp/pyroon$$
    fi
    cp /tmp/pyroon$$ ${ROONCONF}
    rm -f /tmp/pyroon$$
}

set_fade_in() {
    grep -v FADE_IN ${ROONCONF} > /tmp/pyroon$$
    if [ "$1" == "on" ]
    then
      echo "FADE_IN=true" >> /tmp/pyroon$$
    else
      echo "FADE_IN=false" >> /tmp/pyroon$$
    fi
    cp /tmp/pyroon$$ ${ROONCONF}
    rm -f /tmp/pyroon$$
}

set_fade_time() {
    grep -v FADE_TIME ${ROONCONF} > /tmp/pyroon$$
    echo "FADE_TIME=$1" >> /tmp/pyroon$$
    cp /tmp/pyroon$$ ${ROONCONF}
    rm -f /tmp/pyroon$$
}

fade_in() {
    for f in ${!finish[@]}
    do
      finish[$f]=0
    done
    echo "Restoring volume levels in ${FADE_ZONE} zone"
    while true
    do
      for z in ${!zones[@]}
      do
        cvol=${curvol[$z]}
        zone=${zones[$z]}
        step=${outstepsz[$z]}
        zvol=`get_zone_volume -n -z "${zone}"`
        boom=$((cvol - zvol))
        if [ ${boom} -le ${step} ]
        then
          [ ${finish[$z]} -eq 1 ] || {
            set_volume -v "${cvol}" -z "${zone}"
            finish[$z]=1
          }
        else
          set_volume -r -v "${step}" -z "${zone}"
        fi
      done
      faded=1
      for fin in ${finish[@]}
      do
          [ ${fin} -eq 0 ] && {
              faded=
              break
          }
      done
      [ "${faded}" ] && break
    done
}

fade_out() {
    FADE_DRTN=30
    [ "${FADE_TIME}" ] && {
      FADE_DRTN=${FADE_TIME}
    }
    zones=()
    curvol=()
    finish=()
    minvol=()
    outstepsz=()
    outdiv=$((FADE_DRTN / 4))
    while read voline
    do
      zone=`echo "${voline}" | awk -F ':' ' { print $1 } ' | \
                               sed -e 's/^ *//' -e 's/ *$//'`
      zones+=( "${zone}" )
      volume=`echo "${voline}" | awk -F ':' ' { print $2 } ' | \
                                 awk -F ',' ' { print $1 } ' | \
                                 awk -F '=' ' { print $2 } ' | \
                                 sed -e 's/^ *//' -e 's/ *$//'`
      curvol+=( ${volume} )
      finish+=( 0 )
      minimum=`echo "${voline}" | awk -F ':' ' { print $2 } ' | \
                                  awk -F ',' ' { print $2 } ' | \
                                  awk -F '=' ' { print $2 } ' | \
                                  sed -e 's/^ *//' -e 's/ *$//'`
      minvol+=( ${minimum} )
      diff=$((volume - minimum))
      outstep=$((diff / outdiv))
      outstepsz+=( ${outstep} )
    done < <(get_zone_volume -g -z "${FADE_ZONE}")
    echo "Fading volume levels in ${FADE_ZONE} zone"
    while true
    do
      for z in ${!zones[@]}
      do
        step=${outstepsz[$z]}
        zone=${zones[$z]}
        mvol=${minvol[$z]}
        zvol=`get_zone_volume -n -z "${zone}"`
        if [ ${zvol} -le ${mvol} ]
        then
          [ ${finish[$z]} -eq 1 ] || finish[$z]=1
        else
          set_volume -r -v "-${step}" -z "${zone}"
        fi
      done
      faded=1
      for fin in ${finish[@]}
      do
        [ ${fin} -eq 0 ] && {
          faded=
          break
        }
      done
      [ "${faded}" ] && {
        roon -c "pause" -z "${FADE_ZONE}"
        break
      }
    done
}

init_pyroon

fadein=
fadetime=
fadeinit=
proceed=
restore=
# Parse the arguments to get the command and zone
while getopts "iIlRt:Vyz:hu" flag; do
    case $flag in
        i)
            [ "${FADE_IN}" = true ] || set_fade_in on
            fadein=1
            ;;
        I)
            [ "${FADE_IN}" = false ] || set_fade_in off
            fadein=1
            ;;
        l)
            LOG="-l"
            ;;
        R)
            ps -ef | grep ${ROONFADE} | grep -v grep > /dev/null && {
              echo "Restoring volume levels"
              grep -v RESTORE_VOLUME ${ROONCONF} > /tmp/pyroon$$
              echo "RESTORE_VOLUME=1" >> /tmp/pyroon$$
              cp /tmp/pyroon$$ ${ROONCONF}
              rm -f /tmp/pyroon$$
              restore=1
            }
            [ "${restore}" ] || {
              echo "${ROONFADE} does not appear to be running"
              echo "Volume levels must be restored manually"
            }
            ;;
        t)
            fadetime="$OPTARG"
            [ "${fadetime}" == "default" ] && fadetime=30
            if [[ ${fadetime} =~ ${POS_INT} ]]
            then
                if [ ${fadetime} -eq ${FADE_TIME} ]
                then
                    echo "Fade duration already set to ${fadetime} seconds"
                else
                    echo "Setting fade duration to ${fadetime} seconds"
                    set_fade_time ${fadetime}
                fi
            else
                echo "${fadetime} is not a positive integer. Ignoring."
            fi
            ;;
        V)
            ps -ef | grep ${ROONFADE} | grep -v grep > /dev/null && {
              echo "Updating restored volume levels for fading"
              grep -v FADE_INIT ${ROONCONF} > /tmp/pyroon$$
              echo "FADE_INIT=1" >> /tmp/pyroon$$
              cp /tmp/pyroon$$ ${ROONCONF}
              rm -f /tmp/pyroon$$
              fadeinit=1
            }
            [ "${fadeinit}" ] || {
              echo "${ROONFADE} does not appear to be running"
              echo "Volume levels must be updated by stopping and restarting fade"
            }
            ;;
        y)
            proceed=1
            ;;
        z)
            FADE_ZONE="$OPTARG"
            ;;
        h|u)
            usage
            ;;
    esac
done
shift $(( OPTIND - 1 ))

[ "${FADE_ZONE}" ] || FADE_ZONE="${ROON_ZONE}"

if [ "$1" ]
then
    [ "$2" ] && {
      echo "Ignoring \"$2\" argument and any other following arguments."
      echo "Only one of 'on', 'off', or 'now' command line arguments are recognized."
    }
    argument=`echo "$1" | tr '[:upper:]' '[:lower:]'`
    if [ "${argument}" == "on" ]
    then
        ps -ef | grep ${ROONFADE} | grep -v grep > /dev/null && {
          if [ "${proceed}" ]
          then
            roon_fade -y off
            init_pyroon
          else
            printf "\n${ROONFADE} appears to be running."
            printf "\nOnly one instance of 'roon_faded' is currently supported."
            printf "\nThe current process can be exited with 'roon_fade off'"
            printf "\nor by answering 'y' below.\n\n"
            while true
            do
              read -p "Exit 'roon_faded' and start a new one ? (y/n) " yn
              case $yn in
                [Yy]* )
                      roon_fade off
                      init_pyroon
                      break
                      ;;
                [Nn]* )
                      printf "\nRoon fading daemon startup aborted."
                      printf "\nExiting.\n\n"
                      exit 1
                      ;;
                    * ) echo "Please answer yes or no."
                      ;;
              esac
            done
          fi
        }
        if [ -x ${ROONFADE} ]
        then
            [ "${ROON_FADE}" = true ] || set_roon_fade on
            [ "${FADE_IN}" ] || set_fade_in on
            [ "${FADE_TIME}" ] || set_fade_time 30
            set_fade_zone
            echo "Starting Roon fade daemon ${ROONFADE}"
            [ "${LOG}" ] && echo "Logging in ${ROONETC}/faded_log.txt"
            ${ROONFADE} ${LOG} -z "${FADE_ZONE}" > /dev/null 2>&1 &
        else
            echo "Roon fade daemon ${ROONFADE} not found or not executable"
        fi
    else
        if [ "${argument}" == "off" ]
        then
            [ "${ROON_FADE}" = true ] && {
                set_roon_fade off
                printf "\nRoon fade disabled in ${ROONCONF}"
                printf "\nWaiting for ${ROONFADE} to exit ..."
                if [ "${proceed}" ]
                then
                  elapsed=10
                else
                  elapsed=0
                fi
                while true
                do
                  running=
                  ps -ef | grep ${ROONFADE} | grep -v grep > /dev/null && {
                    running=1
                    printf "."
                    sleep 2
                    elapsed=$((elapsed + 2))
                  }
                  [ "${running}" ] || {
                    printf " done\n"
                    break
                  }
                  [ ${elapsed} -gt 10 ] && {
                    faded_pid=`ps -ef | grep roon_faded | \
                                        grep -v grep | awk ' { print $2 } '`
                    [ "${faded_pid}" ] && kill ${faded_pid}
                  }
                done
            }
        else
            # For immediate fade we perform the fade here
            if [ "${argument}" == "now" ]
            then
                disabled=
                ps -ef | grep ${ROONFADE} | grep -v grep > /dev/null && {
                    # Disable the fading daemon in this zone
                    roon_fade -y -z "${FADE_ZONE}" off
                    disabled=1
                }
                fade_out
                printf "\nRoon volume has been temporarily faded."
                printf "\nRestore volume levels and continue playback by answering 'y'"
                printf "\nStop playback and exit by answering 'n'\n\n"
                while true
                do
                  read -p "Restore volume levels and continue playback ? (y/n) " yn
                  case $yn in
                    [Yy]* )
                          roon -c "play" -z "${FADE_ZONE}"
                          fade_in
                          break
                          ;;
                    [Nn]* )
                          roon -c "stop" -z "${FADE_ZONE}"
                          fade_in
                          break
                          ;;
                        * ) echo "Please answer yes or no."
                          ;;
                  esac
                done
                [ "${disabled}" ] && roon_fade -y -z "${FADE_ZONE}" on
            else
                usage
            fi
        fi
    fi
else
    [ "${fadeinit}" ] || [ "${restore}" ] || \
    [ "${fadetime}" ] || [ "${fadein}" ] || usage
fi
exit 0
